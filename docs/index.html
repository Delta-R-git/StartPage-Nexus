<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="https://github.com/Delta-R-git">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StartPage NXS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>

    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Nexus" />
    <link rel="manifest" href="/images/site.webmanifest" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;600&display=swap');

        :root {
            --theme-color: #ffffff;
        }

        body {
            background-color: #000000;
            font-family: 'Inter', sans-serif;
            color: #e5e5e5;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #000; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dropdown transition */
        .dropdown-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease-in-out;
            pointer-events: none; /* Prevent clicks when closed */
        }
        
        /* Show on Active class (Click) OR Group Hover */
        .dropdown-content.active,
        .group:hover .dropdown-content {
            max-height: 500px;
            opacity: 1;
            pointer-events: auto;
        }

        /* Glassmorphism for modals/overlays */
        .glass-panel {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Notes Drawer Transitions */
        #notes-drawer {
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        /* Mobile: Bottom Sheet */
        .notes-mobile-hidden { transform: translateY(100%); }
        .notes-mobile-shown { transform: translateY(0); }

        @media (min-width: 768px) {
            /* Desktop: Right Sidebar */
            .notes-desktop-hidden { transform: translateX(100%); }
            .notes-desktop-shown { transform: translateX(0); }
        }

        /* Context Menus */
        .context-menu {
            display: none;
            position: absolute;
            z-index: 100;
        }

        /* Tooltip for large calendar */
        .cal-tooltip {
            visibility: hidden;
            background-color: rgba(0,0,0,0.9);
            color: var(--theme-color);
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            width: max-content;
            max-width: 150px;
            font-size: 10px;
            border: 1px solid #333;
            pointer-events: none;
        }

        .cal-date-large:hover .cal-tooltip {
            visibility: visible;
        }

        /* Custom selection color */
        ::selection {
            background: #333;
            color: var(--theme-color);
        }
    </style>
</head>
<body class="h-screen flex flex-col justify-between p-4 md:p-6 relative selection:bg-[var(--theme-color)] selection:text-black" onclick="handleBodyClick(event)">

    <header class="flex justify-between items-start fade-in" style="animation-delay: 0.1s;">
        <div class="text-left">
            <h1 id="clock-time" class="text-4xl font-extralight tracking-tight text-[var(--theme-color)]">00:00</h1>
            <p id="clock-date" class="text-xs text-neutral-500 font-medium tracking-widest uppercase mt-1">Date</p>
        </div>

        <div class="flex gap-2 md:gap-4 text-neutral-400 -mt-2 -mr-2 md:mt-0 md:mr-0">
            <button onclick="toggleEditMode()" class="hover:text-[var(--theme-color)] transition-colors p-1.5 md:p-2 hover:bg-neutral-900 rounded-full" title="Edit Shortcuts">
                <i class="ph-pencil text-lg md:text-xl"></i>
            </button>
            <button id="notes-toggle-btn" onclick="toggleNotes(event)" class="hover:text-[var(--theme-color)] transition-colors p-1.5 md:p-2 hover:bg-neutral-900 rounded-full" title="Notes">
                <i class="ph-notepad text-lg md:text-xl"></i>
            </button>
            <button id="bookmarks-toggle-btn" onclick="toggleBookmarks(event)" class="hover:text-[var(--theme-color)] transition-colors p-1.5 md:p-2 hover:bg-neutral-900 rounded-full" title="Bookmarks">
                <i class="ph-bookmarks text-lg md:text-xl"></i>
            </button>
        </div>
    </header>

    <main class="flex-grow flex flex-col justify-start pt-32 md:pt-0 md:justify-center items-center w-full max-w-2xl mx-auto z-10 fade-in" style="animation-delay: 0.3s;">
        
        <div id="connection-status" class="h-8 mb-2 flex justify-center items-center opacity-0 transition-opacity duration-700 ease-in-out">
            </div>

        <div class="w-full mb-6 md:mb-12 relative z-50">
            <div class="flex items-center bg-neutral-900/80 backdrop-blur-md border border-neutral-800 rounded-full px-4 py-3 shadow-2xl focus-within:border-neutral-600 transition-all duration-300 hover:border-neutral-700">
                
                <div class="relative group cursor-pointer mr-3 border-r border-neutral-800 pr-3" id="engine-selector-container">
                    <div id="current-engine-icon" onclick="toggleEngineMenu(event)" class="text-neutral-400 hover:text-[var(--theme-color)] transition-colors flex items-center justify-center w-8 h-8 rounded-full hover:bg-white/5">
                        <i class="ph-google-logo text-xl"></i>
                    </div>
                    <div id="engine-menu" class="absolute top-full left-0 mt-4 bg-neutral-900 border border-neutral-800 rounded-lg p-1 hidden group-hover:flex min-w-[180px] shadow-xl glass-panel flex-col gap-1 overflow-hidden z-50">
                        </div>
                </div>

                <form id="search-form" class="flex-grow" onsubmit="handleSearch(event)">
                    <input type="text" id="search-input" 
                        class="w-full bg-transparent text-lg font-light text-[var(--theme-color)] focus:outline-none placeholder-neutral-600 h-full"
                        placeholder="Search..." autocomplete="off">
                </form>

                <button onclick="handleSearch(event)" class="ml-2 text-neutral-500 hover:text-[var(--theme-color)] transition-colors">
                    <i class="ph-magnifying-glass text-xl"></i>
                </button>
            </div>
        </div>

        <div class="w-full grid grid-cols-3 gap-2 md:gap-8 text-center mb-6 md:mb-0">
            
            <div class="relative menu-container group">
                <button onclick="toggleMenu('social', event)" class="flex flex-col md:flex-row items-center justify-center gap-1 md:gap-3 w-full outline-none p-2 md:p-4 rounded-2xl bg-neutral-900/30 border border-transparent hover:border-neutral-800 hover:bg-neutral-900 transition-all duration-300 h-full">
                    <i class="ph-share-network text-xl md:text-2xl text-neutral-500 group-hover:text-[var(--theme-color)] transition-colors"></i>
                    <span class="uppercase text-[10px] md:text-xs tracking-wider md:tracking-[0.2em] text-neutral-500 group-hover:text-neutral-300 transition-colors">Social</span>
                </button>
                <div id="social-dropdown" class="dropdown-content fixed md:absolute left-4 right-4 md:left-1/2 md:right-auto md:-translate-x-1/2 top-1/2 md:top-full -translate-y-1/2 md:translate-y-0 md:w-64 pt-2 z-50 md:z-20">
                    <div class="glass-panel rounded-xl p-3 flex flex-col gap-2 shadow-2xl bg-black/90" id="social-list">
                        </div>
                    <div class="glass-panel border-t-0 rounded-b-xl rounded-t-none p-1 bg-neutral-900/80">
                        <button onclick="openInputModal('add', 'social')" class="w-full text-neutral-500 hover:text-[var(--theme-color)] transition-colors text-xs py-1"><i class="ph-plus"></i></button>
                    </div>
                </div>
            </div>

            <div class="relative menu-container group">
                <button onclick="toggleMenu('chatbots', event)" class="flex flex-col md:flex-row items-center justify-center gap-1 md:gap-3 w-full outline-none p-2 md:p-4 rounded-2xl bg-neutral-900/30 border border-transparent hover:border-neutral-800 hover:bg-neutral-900 transition-all duration-300 h-full">
                    <i class="ph-magic-wand text-xl md:text-2xl text-neutral-500 group-hover:text-[var(--theme-color)] transition-colors"></i>
                    <span class="uppercase text-[10px] md:text-xs tracking-wider md:tracking-[0.2em] text-neutral-500 group-hover:text-neutral-300 transition-colors">AI Chat</span>
                </button>
                <div id="chatbots-dropdown" class="dropdown-content fixed md:absolute left-4 right-4 md:left-1/2 md:right-auto md:-translate-x-1/2 top-1/2 md:top-full -translate-y-1/2 md:translate-y-0 md:w-64 pt-2 z-50 md:z-20">
                    <div class="glass-panel rounded-xl p-3 flex flex-col gap-2 shadow-2xl bg-black/90" id="chatbots-list">
                         </div>
                    <div class="glass-panel border-t-0 rounded-b-xl rounded-t-none p-1 bg-neutral-900/80">
                        <button onclick="openInputModal('add', 'chatbots')" class="w-full text-neutral-500 hover:text-[var(--theme-color)] transition-colors text-xs py-1"><i class="ph-plus"></i></button>
                   </div>
                </div>
            </div>

            <div class="relative menu-container group">
                <button onclick="toggleMenu('history', event)" class="flex flex-col md:flex-row items-center justify-center gap-1 md:gap-3 w-full outline-none p-2 md:p-4 rounded-2xl bg-neutral-900/30 border border-transparent hover:border-neutral-800 hover:bg-neutral-900 transition-all duration-300 h-full">
                    <i class="ph-clock-counter-clockwise text-xl md:text-2xl text-neutral-500 group-hover:text-[var(--theme-color)] transition-colors"></i>
                    <span class="uppercase text-[10px] md:text-xs tracking-wider md:tracking-[0.2em] text-neutral-500 group-hover:text-neutral-300 transition-colors">Recent</span>
                </button>
                <div id="history-dropdown" class="dropdown-content fixed md:absolute left-4 right-4 md:left-1/2 md:right-auto md:-translate-x-1/2 top-1/2 md:top-full -translate-y-1/2 md:translate-y-0 md:w-64 pt-2 z-50 md:z-20">
                    <div class="glass-panel rounded-xl p-3 flex flex-col gap-2 shadow-2xl bg-black/90 text-left">
                        <div id="history-list" class="flex flex-col gap-1">
                            <span class="text-xs text-neutral-600 italic text-center py-2">No recent searches</span>
                        </div>
                        <div class="border-t border-neutral-800 mt-2 pt-2">
                            <button onclick="clearHistory()" class="text-[10px] uppercase tracking-wider text-red-900 hover:text-red-500 text-center w-full transition-colors py-1">Clear History</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="w-full md:hidden flex flex-col items-center mt-6">
             <div class="shortcuts-grid-container w-full flex flex-wrap justify-center gap-3 px-1">
                 </div>
        </div>

    </main>

    <footer class="flex flex-col md:flex-row justify-between items-end gap-4 h-56 fade-in relative px-2 md:px-0" style="animation-delay: 0.5s;">
        
        <div class="w-full md:w-64 h-full flex flex-col justify-end cursor-pointer group flex-shrink-0" onclick="expandCalendar()">
            <div class="glass-panel p-4 rounded-xl border border-neutral-900/50 group-hover:border-neutral-700 transition-colors relative h-full flex flex-col justify-between">
                <div class="absolute top-2 right-2 text-neutral-600 opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="ph-arrows-out-simple"></i>
                </div>
                <div class="flex justify-between items-baseline mb-2">
                    <span id="cal-month" class="text-sm font-semibold text-[var(--theme-color)]">Month</span>
                    <span id="cal-year" class="text-xs text-neutral-500">Year</span>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-[10px] text-neutral-400">
                    </div>
            </div>
        </div>

        <div class="w-full flex-grow h-full hidden md:flex flex-col justify-end">
            <div class="h-full flex items-end justify-center pb-2">
                <div class="shortcuts-grid-container flex flex-wrap justify-center items-end gap-6 content-end">
                    </div>
            </div>
        </div>

        <div class="w-full md:w-64 h-full relative overflow-hidden rounded-xl glass-panel border border-neutral-900/50 flex-shrink-0">
            <canvas id="networkCanvas" class="absolute top-0 left-0 w-full h-full opacity-60"></canvas>
            <div class="absolute bottom-4 right-4 pointer-events-none">
                <p class="text-[10px] text-neutral-600 tracking-widest uppercase">System Online</p>
                <p class="text-[10px] text-neutral-700 tracking-widest uppercase text-right">Net_Vis_01</p>
            </div>
        </div>

    </footer>

    <div id="calendar-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[70] hidden flex justify-center items-center p-8" onclick="closeCalendar(event)">
        <div class="glass-panel p-4 md:p-8 rounded-2xl w-full max-w-2xl shadow-2xl relative" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <button onclick="changeMonth(-1)" class="text-neutral-500 hover:text-[var(--theme-color)] p-2"><i class="ph-caret-left text-2xl"></i></button>
                <div class="text-center">
                    <span id="cal-month-lg" class="text-3xl font-light text-[var(--theme-color)]">Month</span>
                    <span id="cal-year-lg" class="text-xl text-neutral-500 ml-2">Year</span>
                </div>
                <button onclick="changeMonth(1)" class="text-neutral-500 hover:text-[var(--theme-color)] p-2"><i class="ph-caret-right text-2xl"></i></button>
            </div>
            <div id="calendar-grid-lg" class="grid grid-cols-7 gap-2 md:gap-4 text-center text-neutral-400">
                </div>
            <p class="text-[10px] text-neutral-600 mt-4 text-center uppercase tracking-widest">Right-click a date to customize</p>
        </div>
    </div>

    <div id="calendar-context-menu" class="context-menu glass-panel bg-neutral-900 border border-neutral-700 rounded-lg p-3 w-48 shadow-xl hidden flex-col gap-2">
        <p class="text-xs text-neutral-500 uppercase tracking-widest mb-1 border-b border-neutral-800 pb-1">Edit Date</p>
        <div class="flex items-center gap-2">
            <label class="text-xs text-neutral-300 w-10">Color</label>
            <input type="color" id="ctx-color" class="bg-transparent border-none w-8 h-6 cursor-pointer">
        </div>
        <div class="flex flex-col gap-1">
            <label class="text-xs text-neutral-300">Note</label>
            <input type="text" id="ctx-note" class="bg-neutral-800 border border-neutral-700 rounded text-xs text-white px-2 py-1 focus:outline-none focus:border-neutral-500">
        </div>
        <div class="flex justify-between mt-2">
            <button onclick="clearDateData()" class="text-xs text-red-500 hover:text-red-400 px-2 py-1 hover:bg-neutral-800 rounded">Clear</button>
            <button onclick="saveDateData()" class="bg-[var(--theme-color)] text-black text-xs font-bold px-3 py-1 rounded hover:opacity-90">Save</button>
        </div>
    </div>

    <div id="link-context-menu" class="context-menu glass-panel bg-neutral-900 border border-neutral-700 rounded-lg p-2 w-32 shadow-xl hidden flex-col gap-1">
        <button onclick="editLink()" class="text-left text-xs text-neutral-300 hover:text-[var(--theme-color)] hover:bg-neutral-800 p-2 rounded transition-colors flex items-center gap-2"><i class="ph-pencil-simple"></i> Edit</button>
        <button onclick="deleteLink()" class="text-left text-xs text-red-400 hover:text-red-300 hover:bg-neutral-800 p-2 rounded transition-colors flex items-center gap-2"><i class="ph-trash"></i> Delete</button>
    </div>

    <div id="input-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] hidden flex justify-center items-center p-4">
        <div class="glass-panel bg-neutral-900/90 rounded-2xl p-6 w-full max-w-sm shadow-2xl border border-neutral-800">
            <h3 id="modal-title" class="text-sm font-light text-[var(--theme-color)] mb-4 uppercase tracking-wider">Edit Link</h3>
            
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] text-neutral-500 uppercase">Website URL</label>
                    <input type="text" id="modal-url" class="w-full bg-black border border-neutral-700 rounded p-2 text-xs text-white focus:outline-none focus:border-[var(--theme-color)] mt-1" placeholder="https://...">
                </div>
                <div>
                    <label class="text-[10px] text-neutral-500 uppercase">Name (Optional)</label>
                    <input type="text" id="modal-name" class="w-full bg-black border border-neutral-700 rounded p-2 text-xs text-white focus:outline-none focus:border-[var(--theme-color)] mt-1" placeholder="e.g. Google">
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeInputModalWrapper()" class="text-xs text-neutral-500 hover:text-white px-3 py-2">Cancel</button>
                <button onclick="saveInputData()" class="bg-[var(--theme-color)] text-black px-4 py-2 rounded text-xs font-bold hover:opacity-90 transition-colors">Save</button>
            </div>
        </div>
    </div>

    <div id="notes-drawer" class="fixed z-50 glass-panel bg-black/95 flex flex-col
        bottom-0 left-0 w-full h-[50vh] 
        md:top-0 md:right-0 md:left-auto md:w-1/3 md:h-full
        notes-mobile-hidden notes-desktop-hidden
        border-t md:border-t-0 md:border-l border-neutral-800">
        <div class="flex justify-between items-center p-6 border-b border-neutral-800">
            <h2 class="text-sm font-light tracking-widest uppercase flex items-center gap-2">
                <i class="ph-notepad text-lg"></i> Quick Notes
            </h2>
            <button onclick="closeNotes()" class="text-neutral-500 hover:text-[var(--theme-color)] p-2 rounded-full hover:bg-neutral-800"><i class="ph-x text-xl"></i></button>
        </div>
        <textarea id="notes-area" class="flex-grow bg-transparent p-8 text-neutral-300 font-mono text-sm resize-none focus:outline-none leading-relaxed" placeholder="Type your thoughts here..."></textarea>
    </div>

    <div id="bookmarks-drawer" class="fixed top-0 right-0 w-full md:w-80 h-full glass-panel bg-black/95 transform translate-x-full transition-transform duration-500 ease-in-out z-50 flex flex-col border-l border-neutral-800 shadow-2xl">
        <div class="flex justify-between items-center p-6 border-b border-neutral-800">
            <h2 class="text-sm font-light tracking-widest uppercase flex items-center gap-2">
                <i class="ph-bookmarks text-lg"></i> Bookmarks
            </h2>
            <button onclick="closeBookmarks()" class="text-neutral-500 hover:text-[var(--theme-color)] p-2 rounded-full hover:bg-neutral-800"><i class="ph-x text-xl"></i></button>
        </div>
        
        <div class="p-4 flex flex-col gap-2 border-b border-neutral-800">
            <div class="flex gap-2">
                <input type="text" id="bm-title" placeholder="Name" class="w-1/3 bg-neutral-900 border border-neutral-800 rounded px-2 py-2 text-xs text-white focus:outline-none focus:border-[var(--theme-color)]">
                <input type="text" id="bm-url" placeholder="URL" class="w-2/3 bg-neutral-900 border border-neutral-800 rounded px-2 py-2 text-xs text-white focus:outline-none focus:border-[var(--theme-color)]">
                <button onclick="addBookmark()" class="bg-[var(--theme-color)] text-black rounded px-3 text-xs font-bold hover:opacity-90 flex-shrink-0"><i class="ph-plus"></i></button>
            </div>
            <div class="flex justify-end">
                 <button onclick="triggerBookmarkImport()" class="text-[10px] text-neutral-500 hover:text-[var(--theme-color)] flex items-center gap-1 transition-colors"><i class="ph-upload-simple"></i> Import from Browser HTML</button>
                 <input type="file" id="bookmark-import-file" class="hidden" accept=".html" onchange="handleBookmarkImport(this)">
            </div>
        </div>

        <div id="bookmarks-list" class="flex-grow overflow-y-auto p-4 flex flex-col gap-2">
            </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex justify-center items-center p-4">
        <div class="glass-panel bg-neutral-900/90 rounded-2xl p-4 md:p-6 w-[90vw] md:w-full max-w-lg shadow-2xl border border-neutral-800">
            
            <div class="flex justify-between items-center mb-6 border-b border-neutral-800 pb-4">
                <h3 class="text-lg font-light text-[var(--theme-color)] flex items-center gap-2"><i class="ph-pencil-simple"></i> Customize</h3>
                <button onclick="closeEditMode()" class="text-neutral-500 hover:text-[var(--theme-color)]"><i class="ph-x text-xl"></i></button>
            </div>
            
            <div class="space-y-6 max-h-[60vh] overflow-y-auto pr-2 custom-scroll">
                
                <div class="mb-4 pb-4 border-b border-neutral-800 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                         <h4 class="text-xs uppercase text-neutral-500 tracking-wider">Theme & Data</h4>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="color" id="theme-color-picker" class="w-10 h-8 bg-transparent border border-neutral-700 rounded cursor-pointer p-0.5" oninput="previewTheme(this.value)" title="Change Theme Color">
                        <button onclick="resetTheme()" class="text-[10px] text-red-400 hover:text-red-300 uppercase tracking-wider border border-red-900/50 px-2 py-1.5 rounded hover:bg-red-900/20 transition-colors">Reset</button>
                        
                        <div class="flex-grow"></div>
                        <h4 class="text-xs uppercase text-neutral-500 tracking-wider">Data</h4>
                        <button onclick="exportData()" class="text-neutral-400 hover:text-[var(--theme-color)] transition-colors p-2 rounded bg-neutral-800 border border-neutral-700" title="Export Config">
                            <i class="ph-upload-simple text-lg"></i> Export
                        </button>
                        <button onclick="triggerImport()" class="text-neutral-400 hover:text-[var(--theme-color)] transition-colors p-2 rounded bg-neutral-800 border border-neutral-700" title="Import Config">
                            <i class="ph-download-simple text-lg"></i> Import
                        </button>
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="handleImport(this)">
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xs uppercase text-neutral-500 tracking-wider">Social Links (JSON)</h4>
                        <div class="flex items-center gap-2">
                            <button onclick="resetSection('social')" class="text-[10px] text-red-400 hover:text-red-300 uppercase tracking-wider border border-red-900/50 px-2 py-1 rounded hover:bg-red-900/20 transition-colors">Reset</button>
                            <span class="text-[10px] text-neutral-600">Icon names from <a href="https://phosphoricons.com/" target="_blank" class="text-[10px] text-[var(--theme-color)] hover:text-neutral-300 transition-colors">Phosphor</a></span>
                        </div>
                    </div>
                    <textarea id="edit-social" class="w-full h-32 bg-black border border-neutral-800 rounded-lg p-4 text-xs font-mono text-green-500 focus:outline-none focus:border-[var(--theme-color)] leading-relaxed whitespace-pre-wrap break-all"></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xs uppercase text-neutral-500 tracking-wider">Chatbot Links (JSON)</h4>
                        <div class="flex items-center gap-2"> 
                            <button onclick="resetSection('chatbots')" class="text-[10px] text-red-400 hover:text-red-300 uppercase tracking-wider border border-red-900/50 px-2 py-1 rounded hover:bg-red-900/20 transition-colors">Reset</button>
                            <span class="text-[10px] text-neutral-600">Icon names from <a href="https://phosphoricons.com/" target="_blank" class="text-[10px] text-[var(--theme-color)] hover:text-neutral-300 transition-colors">Phosphor</a></span>
                        </div>
                    </div>
                    <textarea id="edit-chatbots" class="w-full h-32 bg-black border border-neutral-800 rounded-lg p-4 text-xs font-mono text-green-500 focus:outline-none focus:border-[var(--theme-color)] leading-relaxed whitespace-pre-wrap break-all"></textarea>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3 pt-4 border-t border-neutral-800">
                <button onclick="saveConfig()" class="bg-[var(--theme-color)] text-black px-6 py-2 rounded-lg text-sm font-semibold hover:opacity-90 transition-colors shadow-lg shadow-[var(--theme-color)]/20">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Configuration & State ---
        const defaultSocials = [
            { name: "Instagram", url: "https://instagram.com", icon: "ph-instagram-logo" },
            { name: "Pinterest", url: "https://pinterest.com", icon: "ph-pinterest-logo" },
            { name: "Twitter", url: "https://twitter.com", icon: "ph-twitter-logo" },
            { name: "Reddit", url: "https://reddit.com", icon: "ph-reddit-logo" },
            { name: "YouTube", url: "https://youtube.com", icon: "ph-youtube-logo" }
        ];

        const defaultChatbots = [
            { name: "Gemini", url: "https://gemini.google.com", icon: "ph-sparkle" },
            { name: "ChatGPT", url: "https://chat.openai.com", icon: "ph-chat-circle-text" },
            { name: "DeepSeek", url: "https://chat.deepseek.com", icon: "ph-magnifying-glass" },
            { name: "Claude", url: "https://claude.ai", icon: "ph-brain" },
            { name: "Perplexity", url: "https://perplexity.ai", icon: "ph-question" }
        ];

        const defaultBottomShortcuts = [
            { name: "Gmail", url: "https://mail.google.com" },
            { name: "Maps", url: "https://maps.google.com" },
            { name: "GitHub", url: "https://github.com" },
            { name: "Wikipedia", url: "https://wikipedia.com" },
            { name: "TED", url: "https://ted.com/" },
            { name: "Amazon", url: "https://amazon.com" }
        ];

        const searchEngines = {
            google: { url: "https://www.google.com/search?q=", icon: "ph-google-logo", name: "Google" },
            bing: { url: "https://www.bing.com/search?q=", icon: "ph-windows-logo", name: "Bing" },
            duckduckgo: { url: "https://duckduckgo.com/?q=", icon: "ph-bird", name: "DuckDuckGo" },
            brave: { url: "https://search.brave.com/search?q=", icon: "ph-shield", name: "Brave" },
            startpage: { url: "https://www.startpage.com/do/search?q=", icon: "ph-star", name: "Startpage" },
            perplexity: { url: "https://www.perplexity.ai/search?q=", icon: "ph-asterisk", name: "Perplexity" },
            youtube: { url: "https://www.youtube.com/results?search_query=", icon: "ph-youtube-logo", name: "YouTube" }
        };

        let socials = JSON.parse(localStorage.getItem('dash_socials')) || defaultSocials;
        let chatbots = JSON.parse(localStorage.getItem('dash_chatbots')) || defaultChatbots;
        let bottomShortcuts = JSON.parse(localStorage.getItem('dash_bottom_shortcuts')) || defaultBottomShortcuts;
        let bookmarks = JSON.parse(localStorage.getItem('dash_bookmarks')) || [];
        let searchHistory = JSON.parse(localStorage.getItem('dash_history')) || [];
        let calendarData = JSON.parse(localStorage.getItem('dash_calendar_data')) || {};
        let currentEngine = localStorage.getItem('dash_engine') || 'google';
        
        // Theme color
        let savedThemeColor = localStorage.getItem('dash_theme_color') || '#ffffff';
        document.documentElement.style.setProperty('--theme-color', savedThemeColor);

        // Helper to convert hex to RGB for canvas
        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 255, b: 255 };
        }
        let themeRgb = hexToRgb(savedThemeColor);

        let currentLinkType = null;
        let currentLinkIndex = null;
        let dragSrcIndex = null; // Global for drag and drop
        
        let displayDate = new Date(); // State for large calendar

        // Input Modal State
        let inputModalState = {
            mode: 'add', // or 'edit'
            type: null, // 'social', 'chatbots', 'shortcuts'
            index: null
        };
        
        // --- Theme Logic ---
        function previewTheme(color) {
            document.documentElement.style.setProperty('--theme-color', color);
            themeRgb = hexToRgb(color);
        }
        
        function resetTheme() {
             const defaultColor = '#ffffff';
             document.getElementById('theme-color-picker').value = defaultColor;
             previewTheme(defaultColor);
        }

        // --- History API Handler ---
        window.addEventListener('popstate', (event) => {
            closeAllUI(false); 
        });

        function closeAllUI(goBack = true) {
            // Revert theme if not saved
            if(localStorage.getItem('dash_theme_color') !== getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim()) {
                 const saved = localStorage.getItem('dash_theme_color') || '#ffffff';
                 document.documentElement.style.setProperty('--theme-color', saved);
                 themeRgb = hexToRgb(saved);
            }

            const notesDrawer = document.getElementById('notes-drawer');
            if (notesDrawer.classList.contains('notes-desktop-shown') || notesDrawer.classList.contains('notes-mobile-shown')) {
                notesDrawer.classList.remove('notes-desktop-shown', 'notes-mobile-shown');
                notesDrawer.classList.add('notes-desktop-hidden', 'notes-mobile-hidden');
            }

            const bmDrawer = document.getElementById('bookmarks-drawer');
            if (!bmDrawer.classList.contains('translate-x-full')) {
                bmDrawer.classList.add('translate-x-full');
            }

            const editModal = document.getElementById('edit-modal');
            if (!editModal.classList.contains('hidden')) {
                editModal.classList.add('hidden');
            }

            const calModal = document.getElementById('calendar-modal');
            if (!calModal.classList.contains('hidden')) {
                calModal.classList.add('hidden');
            }

            const inputModal = document.getElementById('input-modal');
            if (!inputModal.classList.contains('hidden')) {
                inputModal.classList.add('hidden');
            }

            hideContextMenus();
        }

        // --- 2. Clock & Date ---
        function updateTime() {
            const now = new Date();
            document.getElementById('clock-time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-date').textContent = now.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // --- 3. UI Toggles & Interactions ---
        function handleBodyClick(e) {
            if (!e.target.closest('.menu-container')) {
                document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('active'));
            }
            if (!e.target.closest('#engine-selector-container')) {
                const menu = document.getElementById('engine-menu');
                menu.classList.add('hidden');
                menu.classList.remove('flex');
            }
            if (!e.target.closest('.context-menu')) {
                hideContextMenus();
            }

            const notesDrawer = document.getElementById('notes-drawer');
            const notesBtn = e.target.closest('#notes-toggle-btn');
            
            if (notesDrawer && !notesDrawer.contains(e.target) && !notesBtn) {
                const isDesktop = window.innerWidth >= 768;
                const isOpen = isDesktop ? notesDrawer.classList.contains('notes-desktop-shown') : notesDrawer.classList.contains('notes-mobile-shown');
                if(isOpen) {
                    history.back();
                }
            }

            const bmDrawer = document.getElementById('bookmarks-drawer');
            const bmBtn = e.target.closest('#bookmarks-toggle-btn');
            const isOpen = !bmDrawer.classList.contains('translate-x-full');
            
            if (isOpen && bmDrawer && !bmDrawer.contains(e.target) && !bmBtn) {
                history.back(); 
            }
        }

        function toggleMenu(type, event) {
            event.stopPropagation();
            const dropdown = document.getElementById(`${type}-dropdown`);
            const isActive = dropdown.classList.contains('active');
            document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('active'));
            if (!isActive) dropdown.classList.add('active');
        }

        // --- Input Modal Functions ---
        function openInputModal(mode, type, index = null) {
            history.pushState({ui: 'input'}, '', '#input');
            inputModalState = { mode, type, index };
            const modal = document.getElementById('input-modal');
            const titleEl = document.getElementById('modal-title');
            const urlEl = document.getElementById('modal-url');
            const nameEl = document.getElementById('modal-name');

            urlEl.value = '';
            nameEl.value = '';

            titleEl.textContent = mode === 'add' ? `Add to ${type}` : `Edit ${type}`;

            if (mode === 'edit' && index !== null) {
                let item;
                if (type === 'social') item = socials[index];
                else if (type === 'chatbots') item = chatbots[index];
                else if (type === 'shortcuts') item = bottomShortcuts[index];

                if (item) {
                    urlEl.value = item.url;
                    nameEl.value = item.name;
                }
            }

            modal.classList.remove('hidden');
            urlEl.focus();
            
            document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('active'));
        }

        function closeInputModal() {
            document.getElementById('input-modal').classList.add('hidden');
        }
        
        function closeInputModalWrapper() {
            history.back();
        }

        function saveInputData() {
            const url = document.getElementById('modal-url').value.trim();
            let name = document.getElementById('modal-name').value.trim();

            if (!url) {
                alert("Please enter a URL");
                return;
            }

            if (!name) {
                try {
                    const hostname = new URL(url.startsWith('http') ? url : 'https://' + url).hostname;
                    name = hostname.replace('www.', '').split('.')[0];
                    name = name.charAt(0).toUpperCase() + name.slice(1);
                } catch(e) { name = "Link"; }
            }

            const fullUrl = url.startsWith('http') ? url : 'https://' + url;
            let icon = "ph-globe"; 
            if(inputModalState.type === 'chatbots') icon = "ph-magic-wand";
            if(inputModalState.type === 'social') icon = "ph-share-network";

            const newItem = { name: name, url: fullUrl, icon: icon };

            const { mode, type, index } = inputModalState;

            let targetList;
            let storageKey;

            if (type === 'social') {
                targetList = socials;
                storageKey = 'dash_socials';
            } else if (type === 'chatbots') {
                targetList = chatbots;
                storageKey = 'dash_chatbots';
            } else if (type === 'shortcuts') {
                targetList = bottomShortcuts;
                storageKey = 'dash_bottom_shortcuts';
                delete newItem.icon;
            }

            if (mode === 'add') {
                targetList.push(newItem);
            } else if (mode === 'edit' && index !== null) {
                if(type !== 'shortcuts') {
                    newItem.icon = targetList[index].icon;
                }
                targetList[index] = newItem;
            }

            localStorage.setItem(storageKey, JSON.stringify(targetList));

            if (type === 'social') renderLinks('social-list', socials, 'social');
            else if (type === 'chatbots') renderLinks('chatbots-list', chatbots, 'chatbots');
            else if (type === 'shortcuts') renderBottomShortcuts();

            history.back(); 
        }


        // --- 4. Notes & Bookmarks Logic ---
        function toggleNotes(e) {
            if(e) e.stopPropagation();
            const drawer = document.getElementById('notes-drawer');
            const isDesktop = window.innerWidth >= 768;
            
            const isOpen = isDesktop ? drawer.classList.contains('notes-desktop-shown') : drawer.classList.contains('notes-mobile-shown');

            if (isOpen) {
                history.back();
            } else {
                history.pushState({ui: 'notes'}, '', '#notes');
                if (isDesktop) {
                    drawer.classList.remove('notes-desktop-hidden');
                    drawer.classList.add('notes-desktop-shown');
                    drawer.classList.remove('notes-mobile-shown');
                    drawer.classList.add('notes-mobile-hidden');
                } else {
                    drawer.classList.remove('notes-mobile-hidden');
                    drawer.classList.add('notes-mobile-shown');
                    drawer.classList.remove('notes-desktop-shown');
                    drawer.classList.add('notes-desktop-hidden');
                }
            }
        }
        
        function closeNotes() {
            history.back();
        }

        function toggleBookmarks(e) {
            if(e) e.stopPropagation();
            const drawer = document.getElementById('bookmarks-drawer');
            const isOpen = !drawer.classList.contains('translate-x-full');
            
            if(isOpen) {
                history.back();
            } else {
                history.pushState({ui: 'bookmarks'}, '', '#bookmarks');
                drawer.classList.remove('translate-x-full');
            }
        }
        
        function closeBookmarks() {
            history.back();
        }

        // --- 6. Search Engine Logic ---
        function toggleEngineMenu(e) {
            if(e) e.stopPropagation();
            const menu = document.getElementById('engine-menu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                menu.classList.add('flex');
                renderEngineOptions();
            } else {
                menu.classList.add('hidden');
                menu.classList.remove('flex');
            }
        }

        function setEngine(engineKey) {
            currentEngine = engineKey;
            localStorage.setItem('dash_engine', engineKey);
            const iconContainer = document.getElementById('current-engine-icon');
            iconContainer.innerHTML = `<i class="${searchEngines[engineKey].icon} text-xl"></i>`;
            const menu = document.getElementById('engine-menu');
            menu.classList.add('hidden');
            menu.classList.remove('flex');
        }

        function renderEngineOptions() {
            const menu = document.getElementById('engine-menu');
            menu.innerHTML = '';
            Object.keys(searchEngines).forEach(key => {
                const eng = searchEngines[key];
                const div = document.createElement('div');
                div.className = `flex items-center gap-3 p-3 rounded cursor-pointer transition-colors ${currentEngine === key ? 'bg-white text-black' : 'text-neutral-400 hover:text-[var(--theme-color)] hover:bg-white/10'}`;
                div.onclick = (e) => { e.stopPropagation(); setEngine(key); };
                div.innerHTML = `
                    <i class="${eng.icon} text-lg"></i>
                    <span class="text-xs font-medium">${eng.name}</span>
                `;
                menu.appendChild(div);
            });
        }
        
        renderEngineOptions();

        function handleSearch(e) {
            e.preventDefault();
            const input = document.getElementById('search-input');
            const query = input.value.trim();
            if (query) {
                searchHistory.unshift(query);
                if (searchHistory.length > 10) searchHistory.pop();
                localStorage.setItem('dash_history', JSON.stringify(searchHistory));
                renderHistory();
                const engineUrl = searchEngines[currentEngine].url;
                window.open(`${engineUrl}${encodeURIComponent(query)}`, '_blank');
                input.value = '';
                input.blur();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const iconContainer = document.getElementById('current-engine-icon');
            iconContainer.innerHTML = `<i class="${searchEngines[currentEngine].icon} text-xl"></i>`;
        });


        // --- 7. Rendering Lists & Context Menus ---
        function renderLinks(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach((item, index) => {
                const a = document.createElement('a');
                a.href = item.url;
                a.target = "_blank"; 
                a.className = "flex items-center gap-3 p-2 rounded-lg hover:bg-white/10 transition-colors text-sm text-neutral-300 hover:text-[var(--theme-color)] group-link";
                a.innerHTML = `
                    <i class="${item.icon || 'ph-link'} text-lg text-neutral-500 group-link-hover:text-[var(--theme-color)] transition-colors"></i>
                    <span>${item.name}</span>
                `;
                a.oncontextmenu = (e) => openLinkContextMenu(e, type, index);
                container.appendChild(a);
            });
        }

        function openLinkContextMenu(e, type, index) {
            e.preventDefault();
            e.stopPropagation();
            currentLinkType = type;
            currentLinkIndex = index;
            
            const menu = document.getElementById('link-context-menu');
            menu.style.display = 'flex';
            
            let left = e.pageX;
            let top = e.pageY;
            
            if (left + 150 > window.innerWidth) {
                left = window.innerWidth - 160; 
            }
            
            if (top + 100 > window.innerHeight) {
                top = window.innerHeight - 110;
            }

            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;
            
            document.getElementById('calendar-context-menu').style.display = 'none';
        }

        function editLink() {
            hideContextMenus();
            if (currentLinkType && currentLinkIndex !== null) {
                openInputModal('edit', currentLinkType, currentLinkIndex);
            }
        }

        function deleteLink() {
            hideContextMenus();
            if (currentLinkType && currentLinkIndex !== null) {
                let targetList, storageKey;
                
                if(currentLinkType === 'social') {
                    targetList = socials;
                    storageKey = 'dash_socials';
                } else if(currentLinkType === 'chatbots') {
                    targetList = chatbots;
                    storageKey = 'dash_chatbots';
                } else if(currentLinkType === 'shortcuts') {
                    targetList = bottomShortcuts;
                    storageKey = 'dash_bottom_shortcuts';
                }

                if (confirm("Are you sure you want to delete this link?")) {
                    targetList.splice(currentLinkIndex, 1);
                    localStorage.setItem(storageKey, JSON.stringify(targetList));
                    
                    if(currentLinkType === 'social') renderLinks('social-list', socials, 'social');
                    else if(currentLinkType === 'chatbots') renderLinks('chatbots-list', chatbots, 'chatbots');
                    else if(currentLinkType === 'shortcuts') renderBottomShortcuts();
                }
            }
        }

        // Render Bottom Shortcuts Grid (Favicons)
        function renderBottomShortcuts() {
            const containers = document.querySelectorAll('.shortcuts-grid-container');
            
            containers.forEach(container => {
                container.innerHTML = '';
                
                bottomShortcuts.forEach((item, index) => {
                    const a = document.createElement('a');
                    a.href = item.url;
                    a.target = "_blank";
                    a.draggable = true;
                    a.className = "flex flex-col items-center gap-1 group w-12 cursor-grab active:cursor-grabbing relative select-none touch-none"; 
                    a.setAttribute('data-index', index);

                    a.innerHTML = `
                        <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-neutral-900 border border-transparent group-hover:border-neutral-700 transition-all overflow-hidden pointer-events-none">
                            <img src="https://www.google.com/s2/favicons?domain=${item.url}&sz=64" alt="${item.name}" class="w-6 h-6 object-contain opacity-70 group-hover:opacity-100 transition-opacity" onerror="this.src='https://unpkg.com/@phosphor-icons/core@2.0.0/assets/globe.svg'; this.style.filter='invert(1)'">
                        </div>
                        <span class="text-[10px] text-neutral-600 group-hover:text-[var(--theme-color)] transition-colors truncate w-full text-center pointer-events-none">${item.name}</span>
                    `;
                    
                    a.oncontextmenu = (e) => openLinkContextMenu(e, 'shortcuts', index);

                    a.ondragstart = (e) => {
                        dragSrcIndex = parseInt(a.getAttribute('data-index'));
                        e.dataTransfer.effectAllowed = 'move';
                        a.style.opacity = '0.4';
                    };
                    
                    a.ondragend = (e) => {
                        a.style.opacity = '1';
                        dragSrcIndex = null;
                        renderBottomShortcuts();
                    };

                    a.ondragover = (e) => {
                        if (e.preventDefault) e.preventDefault(); 
                        e.dataTransfer.dropEffect = 'move';
                        return false;
                    };

                    a.ondrop = (e) => {
                        e.stopPropagation();
                        let currentIdx = parseInt(a.getAttribute('data-index'));
                        if (dragSrcIndex !== null && dragSrcIndex !== currentIdx) {
                            const [movedItem] = bottomShortcuts.splice(dragSrcIndex, 1);
                            bottomShortcuts.splice(currentIdx, 0, movedItem);
                            localStorage.setItem('dash_bottom_shortcuts', JSON.stringify(bottomShortcuts));
                        }
                        return false;
                    };

                    let touchStartX = 0;
                    let touchStartY = 0;
                    let isDragging = false;
                    
                    a.addEventListener('touchstart', (e) => {
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        isDragging = false;
                        a.setAttribute('data-dragged', 'false');
                        a.style.transition = 'none'; 
                    }, {passive: false});

                    a.addEventListener('touchmove', (e) => {
                        const touch = e.touches[0];
                        const deltaX = Math.abs(touch.clientX - touchStartX);
                        const deltaY = Math.abs(touch.clientY - touchStartY);

                        if (deltaX > 10 || deltaY > 10) {
                            isDragging = true;
                            a.setAttribute('data-dragged', 'true');
                            e.preventDefault(); 

                            a.style.opacity = '0.5';
                            a.style.transform = `translate(${touch.clientX - touchStartX}px, ${touch.clientY - touchStartY}px)`;
                            a.style.zIndex = '50';
                            
                            const prevDisplay = a.style.display;
                            a.style.display = 'none';
                            const target = document.elementFromPoint(touch.clientX, touch.clientY);
                            a.style.display = prevDisplay;

                            const targetLink = target ? target.closest('a') : null;
                            
                            container.querySelectorAll('a').forEach(el => el.classList.remove('ring-2', 'ring-[var(--theme-color)]', 'rounded-lg'));

                            if (targetLink && targetLink !== a && targetLink.parentElement === container) {
                                targetLink.classList.add('ring-2', 'ring-[var(--theme-color)]', 'rounded-lg');
                                a.setAttribute('data-potential-drop', targetLink.getAttribute('data-index'));
                            } else {
                                a.removeAttribute('data-potential-drop');
                            }
                        }
                    }, {passive: false});

                    a.addEventListener('touchend', (e) => {
                        a.style.opacity = '1';
                        a.style.transform = 'none';
                        a.style.zIndex = 'auto';
                        
                        container.querySelectorAll('a').forEach(el => el.classList.remove('ring-2', 'ring-[var(--theme-color)]', 'rounded-lg'));

                        if (isDragging) {
                            const dropIndex = a.getAttribute('data-potential-drop');
                            if (dropIndex !== null) {
                                const fromIndex = parseInt(a.getAttribute('data-index'));
                                const toIndex = parseInt(dropIndex);
                                
                                if (!isNaN(fromIndex) && !isNaN(toIndex) && fromIndex !== toIndex) {
                                    const [movedItem] = bottomShortcuts.splice(fromIndex, 1);
                                    bottomShortcuts.splice(toIndex, 0, movedItem);
                                    localStorage.setItem('dash_bottom_shortcuts', JSON.stringify(bottomShortcuts));
                                    renderBottomShortcuts(); 
                                }
                            }
                            if (e.cancelable) e.preventDefault();
                        }
                        
                        isDragging = false;
                    });
                    
                    container.appendChild(a);
                });
            });
            
            const createAddBtn = () => {
                const btn = document.createElement('button');
                btn.onclick = () => openInputModal('add', 'shortcuts');
                btn.className = "flex flex-col items-center gap-1 group w-12"; 
                btn.innerHTML = `
                    <div class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-800 text-neutral-600 hover:text-[var(--theme-color)] hover:border-neutral-600 transition-all">
                        <i class="ph-plus text-lg"></i>
                    </div>
                    <span class="text-[10px] text-transparent">Add</span>
                `;
                return btn;
            };

            containers.forEach(container => {
                container.appendChild(createAddBtn());
            });
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            if (searchHistory.length === 0) {
                container.innerHTML = '<span class="text-xs text-neutral-600 italic text-center py-2">No recent searches</span>';
                return;
            }
            searchHistory.slice(0, 5).forEach(term => { 
                const div = document.createElement('div');
                div.className = "flex justify-between items-center text-xs text-neutral-400 p-2 rounded hover:bg-white/5 hover:text-[var(--theme-color)] cursor-pointer transition-colors group-hist";
                div.innerHTML = `<span class="truncate pr-2">${term}</span> <i class="ph-arrow-square-out opacity-0 group-hist-hover:opacity-100 transition-opacity"></i>`;
                div.onclick = () => window.open(`${searchEngines[currentEngine].url}${encodeURIComponent(term)}`, '_blank');
                container.appendChild(div);
            });
        }

        function clearHistory() {
            searchHistory = [];
            localStorage.removeItem('dash_history');
            renderHistory();
        }

        function renderBookmarks() {
            const container = document.getElementById('bookmarks-list');
            container.innerHTML = '';
            if(bookmarks.length === 0) {
                container.innerHTML = '<span class="text-xs text-neutral-600 italic text-center mt-10">No bookmarks saved</span>';
            }
            bookmarks.forEach((bm, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-neutral-900/50 border border-neutral-800 rounded p-3 hover:border-neutral-600 transition-colors group";
                div.innerHTML = `
                    <a href="${bm.url}" target="_blank" class="flex-grow text-xs text-neutral-300 hover:text-[var(--theme-color)] truncate pr-2 flex items-center gap-2">
                        <img src="https://www.google.com/s2/favicons?domain=${bm.url}&sz=16" class="w-4 h-4 opacity-70" onerror="this.style.display='none'">
                        ${bm.title}
                    </a>
                    <button onclick="removeBookmark(${index})" class="text-neutral-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph-trash"></i></button>
                `;
                container.appendChild(div);
            });
        }

        function addBookmark() {
            const titleInput = document.getElementById('bm-title');
            const urlInput = document.getElementById('bm-url');
            let title = titleInput.value.trim();
            let url = urlInput.value.trim();

            if (url) {
                if (!url.startsWith('http')) url = 'https://' + url;
                
                if (!title) {
                    try {
                        const hostname = new URL(url).hostname;
                        title = hostname.replace('www.', '').split('.')[0];
                        title = title.charAt(0).toUpperCase() + title.slice(1);
                    } catch(e) {
                        title = "Bookmark";
                    }
                }

                bookmarks.push({ title, url });
                localStorage.setItem('dash_bookmarks', JSON.stringify(bookmarks));
                renderBookmarks();
                titleInput.value = '';
                urlInput.value = '';
            }
        }
        
        function triggerBookmarkImport() {
            document.getElementById('bookmark-import-file').click();
        }

        function handleBookmarkImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(e.target.result, "text/html");
                    const links = doc.querySelectorAll('a');
                    let count = 0;
                    links.forEach(a => {
                        const title = a.textContent.trim() || "Bookmark";
                        const url = a.href;
                        if(url && (url.startsWith('http://') || url.startsWith('https://'))) { 
                             bookmarks.push({ title, url });
                             count++;
                        }
                    });
                    
                    if (count > 0) {
                        localStorage.setItem('dash_bookmarks', JSON.stringify(bookmarks));
                        renderBookmarks();
                        alert(`Successfully imported ${count} bookmarks.`);
                    } else {
                         alert("No bookmarks found in the file.");
                    }
                    
                } catch (err) {
                    alert("Failed to parse bookmark file.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function removeBookmark(index) {
            bookmarks.splice(index, 1);
            localStorage.setItem('dash_bookmarks', JSON.stringify(bookmarks));
            renderBookmarks();
        }

        const notesArea = document.getElementById('notes-area');
        notesArea.value = localStorage.getItem('dash_notes') || '';
        notesArea.addEventListener('input', (e) => {
            localStorage.setItem('dash_notes', e.target.value);
        });

        // --- 9. Edit Mode Logic ---
        function toggleEditMode() {
            const modal = document.getElementById('edit-modal');
            const isHidden = modal.classList.contains('hidden');
            if (isHidden) {
                history.pushState({ui: 'edit'}, '', '#edit');
                document.getElementById('theme-color-picker').value = localStorage.getItem('dash_theme_color') || '#ffffff';
                document.getElementById('edit-social').value = JSON.stringify(socials, null, 2);
                document.getElementById('edit-chatbots').value = JSON.stringify(chatbots, null, 2);
                modal.classList.remove('hidden');
            } else {
                history.back();
            }
        }
        
        function closeEditMode() {
            history.back();
        }

        function saveConfig() {
            try {
                const newSocials = JSON.parse(document.getElementById('edit-social').value);
                const newChatbots = JSON.parse(document.getElementById('edit-chatbots').value);
                const newTheme = document.getElementById('theme-color-picker').value;
                
                socials = newSocials;
                chatbots = newChatbots;
                savedThemeColor = newTheme;
                
                localStorage.setItem('dash_socials', JSON.stringify(socials));
                localStorage.setItem('dash_chatbots', JSON.stringify(chatbots));
                localStorage.setItem('dash_theme_color', savedThemeColor);
                
                renderLinks('social-list', socials, 'social');
                renderLinks('chatbots-list', chatbots, 'chatbots');
                previewTheme(savedThemeColor);
                
                history.back(); 
            } catch (e) {
                alert("Invalid JSON format. Please check your syntax.");
            }
        }

        function resetSection(type) {
            if(confirm(`Reset ${type} links to default?`)) {
                if (type === 'social') {
                    socials = defaultSocials;
                    document.getElementById('edit-social').value = JSON.stringify(socials, null, 2);
                } else if (type === 'chatbots') {
                    chatbots = defaultChatbots;
                    document.getElementById('edit-chatbots').value = JSON.stringify(chatbots, null, 2);
                }
            }
        }

        // --- 10. Calendar Widget ---
        let selectedDateKey = null;

        function renderCalendarGrid(containerId, isLarge = false, year, month) {
            const grid = document.getElementById(containerId);
            
            const now = new Date();
            if(year === undefined) year = now.getFullYear();
            if(month === undefined) month = now.getMonth();
            
            const displayDateObj = new Date(year, month, 1);

            if(isLarge) {
                document.getElementById('cal-month-lg').innerText = displayDateObj.toLocaleString('default', { month: 'long' });
                document.getElementById('cal-year-lg').innerText = year;
            } else {
                document.getElementById('cal-month').innerText = displayDateObj.toLocaleString('default', { month: 'long' });
                document.getElementById('cal-year').innerText = year;
            }

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            grid.innerHTML = '';
            
            ['S','M','T','W','T','F','S'].forEach(d => {
                const span = document.createElement('div');
                span.className = isLarge ? "text-neutral-600 font-bold mb-2 text-sm" : "text-neutral-600 font-bold mb-1";
                span.innerText = d;
                grid.appendChild(span);
            });

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            const todayObj = new Date();
            const isCurrentMonth = todayObj.getFullYear() === year && todayObj.getMonth() === month;
            const todayDate = todayObj.getDate();

            for (let i = 1; i <= daysInMonth; i++) {
                const div = document.createElement('div');
                const dateKey = `${year}-${month}-${i}`;
                const data = calendarData[dateKey] || { color: '', note: '' };
                
                let classes = `rounded-sm transition-colors cursor-default ${isLarge ? 'p-2 md:p-4 text-sm md:text-lg cal-date-large relative' : 'p-1 text-[10px]'}`;
                
                let style = '';
                if(data.color) {
                    style = `color: ${data.color}; font-weight: bold;`;
                } else if(isCurrentMonth && i === todayDate) {
                    classes += ' bg-[var(--theme-color)] text-black font-bold';
                } else {
                    classes += ' hover:bg-neutral-800';
                }

                div.className = classes;
                div.style = style;
                div.innerText = i;

                if(isLarge) {
                    div.oncontextmenu = (e) => openContextMenu(e, dateKey);
                    if(data.note) {
                        const tooltip = document.createElement('div');
                        tooltip.className = 'cal-tooltip';
                        tooltip.innerText = data.note;
                        div.appendChild(tooltip);
                        div.style.borderBottom = `2px solid ${data.color || '#555'}`;
                    }
                }

                grid.appendChild(div);
            }
        }

        function generateCalendar() {
            const now = new Date();
            renderCalendarGrid('calendar-grid', false, now.getFullYear(), now.getMonth());
        }

        function expandCalendar() {
            history.pushState({ui: 'calendar'}, '', '#calendar');
            document.getElementById('calendar-modal').classList.remove('hidden');
            displayDate = new Date();
            renderCalendarGrid('calendar-grid-lg', true, displayDate.getFullYear(), displayDate.getMonth());
        }

        function changeMonth(offset) {
            displayDate.setMonth(displayDate.getMonth() + offset);
            renderCalendarGrid('calendar-grid-lg', true, displayDate.getFullYear(), displayDate.getMonth());
        }

        function closeCalendar(e) {
            history.back();
        }

        function openContextMenu(e, dateKey) {
            e.preventDefault();
            selectedDateKey = dateKey;
            const menu = document.getElementById('calendar-context-menu');
            const data = calendarData[dateKey] || { color: '#ffffff', note: '' };
            
            document.getElementById('ctx-color').value = data.color || '#ffffff';
            document.getElementById('ctx-note').value = data.note || '';
            
            menu.style.display = 'flex';
            
            let left = e.pageX;
            let top = e.pageY;
            
            if (left + 200 > window.innerWidth) {
                left = window.innerWidth - 210;
            }
            if (top + 160 > window.innerHeight) {
                top = window.innerHeight - 170;
            }

            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;
            
            document.getElementById('link-context-menu').style.display = 'none';
        }

        function hideContextMenus() {
            document.getElementById('calendar-context-menu').style.display = 'none';
            document.getElementById('link-context-menu').style.display = 'none';
        }

        function saveDateData() {
            if(selectedDateKey) {
                const color = document.getElementById('ctx-color').value;
                const note = document.getElementById('ctx-note').value;
                if(color === '#000000' && !note) {
                    delete calendarData[selectedDateKey];
                } else {
                    calendarData[selectedDateKey] = { color, note };
                }
                localStorage.setItem('dash_calendar_data', JSON.stringify(calendarData));
                renderCalendarGrid('calendar-grid-lg', true, displayDate.getFullYear(), displayDate.getMonth());
                generateCalendar(); 
                hideContextMenus();
            }
        }

        function clearDateData() {
            if(selectedDateKey) {
                delete calendarData[selectedDateKey];
                localStorage.setItem('dash_calendar_data', JSON.stringify(calendarData));
                renderCalendarGrid('calendar-grid-lg', true, displayDate.getFullYear(), displayDate.getMonth());
                generateCalendar(); 
                hideContextMenus();
            }
        }

        // --- 11. Network Visualizer (Canvas) ---
        function initNetworkVisualizer() {
            const canvas = document.getElementById('networkCanvas');
            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];
            
            function resize() {
                if (canvas.parentElement.offsetWidth > 0) {
                    width = canvas.parentElement.offsetWidth;
                    height = canvas.parentElement.offsetHeight;
                    canvas.width = width;
                    canvas.height = height;
                    initParticles();
                }
            }
            window.addEventListener('resize', resize);
            
            let mouse = { x: null, y: null };
            document.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouse.x = e.clientX - rect.left;
                mouse.y = e.clientY - rect.top;
            });
            document.addEventListener('mouseleave', () => { mouse.x = null; mouse.y = null; });

            class Particle {
                constructor() {
                    this.x = Math.random() * width;
                    this.y = Math.random() * height;
                    this.vx = (Math.random() - 0.5) * 0.5;
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.size = Math.random() * 1.5 + 0.5;
                }
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    if (this.x < 0 || this.x > width) this.vx *= -1;
                    if (this.y < 0 || this.y > height) this.vy *= -1;
                    if (mouse.x != null) {
                        let dx = mouse.x - this.x;
                        let dy = mouse.y - this.y;
                        let distance = Math.sqrt(dx*dx + dy*dy);
                        if (distance < 100) {
                            this.x += dx * 0.02;
                            this.y += dy * 0.02;
                        }
                    }
                }
                draw() {
                    ctx.fillStyle = `rgba(${themeRgb.r}, ${themeRgb.g}, ${themeRgb.b}, 0.5)`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            function initParticles() {
                particles = [];
                const particleCount = Math.floor((width * height) / 4000);
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle());
                }
            }

            function animate() {
                ctx.clearRect(0, 0, width, height);
                for (let i = 0; i < particles.length; i++) {
                    particles[i].update();
                    particles[i].draw();
                    for (let j = i; j < particles.length; j++) {
                        let dx = particles[i].x - particles[j].x;
                        let dy = particles[i].y - particles[j].y;
                        let distance = Math.sqrt(dx*dx + dy*dy);
                        if (distance < 80) {
                            ctx.strokeStyle = `rgba(${themeRgb.r}, ${themeRgb.g}, ${themeRgb.b}, ${1 - distance/80})`;
                            ctx.lineWidth = 0.5;
                            ctx.beginPath();
                            ctx.moveTo(particles[i].x, particles[i].y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.stroke();
                        }
                    }
                }
                requestAnimationFrame(animate);
            }
            setTimeout(() => { resize(); animate(); }, 100);
        }

        // --- IMPORT / EXPORT LOGIC ---
        function getAllData() {
            const keys = [
                'dash_socials', 'dash_chatbots', 'dash_bottom_shortcuts',
                'dash_bookmarks', 'dash_history', 'dash_calendar_data',
                'dash_engine', 'dash_notes', 'dash_theme_color'
            ];
            const data = {};
            keys.forEach(key => {
                const val = localStorage.getItem(key);
                if (val) {
                    try {
                        data[key] = JSON.parse(val);
                    } catch (e) {
                        data[key] = val; // handle non-json strings like dash_engine
                    }
                }
            });
            return data;
        }

        function exportData() {
            const data = getAllData();
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dashboard-config.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function triggerImport() {
            document.getElementById('import-file').click();
        }

        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // Validate basic structure if needed, for now trust the user
                    Object.keys(data).forEach(key => {
                        const val = data[key];
                        if (typeof val === 'string') {
                            localStorage.setItem(key, val);
                        } else {
                            localStorage.setItem(key, JSON.stringify(val));
                        }
                    });
                    alert("Import successful! Reloading...");
                    location.reload();
                } catch (err) {
                    alert("Failed to import: Invalid JSON file.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
            // Reset input so same file can be selected again
            input.value = ''; 
        }

        // --- 12. Connection Status Logic ---
        const statusEl = document.getElementById('connection-status');

        function updateConnectionStatus() {
            if (!navigator.onLine) {
                // OFFLINE STATE: Show Red, stay visible
                statusEl.innerHTML = `
                    <div class="px-4 py-1.5 rounded-full border border-red-900/60 bg-red-950/80 text-red-400 text-[10px] uppercase tracking-[0.2em] font-semibold flex items-center gap-2 shadow-[0_0_15px_rgba(220,38,38,0.3)] backdrop-blur-md">
                        <i class="ph-wifi-slash text-sm"></i>
                        <span>Offline</span>
                    </div>
                `;
                statusEl.classList.remove('opacity-0');
            } else {
                // ONLINE STATE: Show Green briefly, then fade out
                statusEl.innerHTML = `
                    <div class="px-4 py-1.5 rounded-full border border-green-900/60 bg-green-950/80 text-green-400 text-[10px] uppercase tracking-[0.2em] font-semibold flex items-center gap-2 shadow-[0_0_15px_rgba(34,197,94,0.3)] backdrop-blur-md">
                        <i class="ph-wifi-high text-sm"></i>
                        <span>Online</span>
                    </div>
                `;
                statusEl.classList.remove('opacity-0');

                // Hide after 2.5 seconds if still online
                setTimeout(() => {
                    if (navigator.onLine) {
                        statusEl.classList.add('opacity-0');
                    }
                }, 2500);
            }
        }

        // Listen for browser events
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Check immediately on load (only show if offline to keep start clean)
        if (!navigator.onLine) {
            updateConnectionStatus();
        }

        // Initialize
        renderLinks('social-list', socials, 'social');
        renderLinks('chatbots-list', chatbots, 'chatbots');
        renderHistory();
        renderBookmarks();
        renderBottomShortcuts();
        generateCalendar();
        initNetworkVisualizer();

    </script>
</body>
</html>